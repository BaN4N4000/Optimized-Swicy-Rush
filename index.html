<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Swicy Rush — Demo</title>
<link href="https://fonts.googleapis.com/css2?family=Chewy&family=Luckiest+Guy&family=Fredoka+One&family=Baloo+2:wght@600&family=Bangers&family=Bubblegum+Sans&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">


<style>
:root {
  --accent: #87ceeb;
  --pink: #ff4da6;
  --bg1: linear-gradient(135deg,#ffdde1,#ee9ca7);
  --fade-out-dur: 500ms;
  --fade-in-dur: 600ms;
}
body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}
html, body {
  height: 100%;
  overflow: hidden;
  touch-action: none; 
  font-family: Inter, system-ui, Arial, sans-serif;
  background: var(--bg1);
  -webkit-font-smoothing: antialiased;
}

body {
  display: flex;
  align-items: center;
  justify-content: center;
}

#appWrapper {
  width: 90%;   
  width: calc(100% - 5%);   /* leaves 10% margin left + right */
  max-width: 90;          /* prevent growing too big on desktop */
  height: 100%;
  margin: 0 auto;            /* centers it */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0;
  box-sizing: border-box;
}

#gameWrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.1vh; 
  max-height: 100vh;      /* fits screen */
}

#mainMenu {
  width: min(80vw, 400px);   /* scale to screen width but not larger than desktop size */
  height: min(95vh, 95vw);   /* scale height, stay square-ish */
}

#gameContainer,
#musicPlayerBox {
  transform: scale(1);      
  transform-origin: center;    /* keep them centered */
} 

#innerBoard {
  width: min(90vw, 90vh, 90%);  /* fit inside viewport and parent */
  aspect-ratio: 1 / 1;          /* always square */
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

#gameInfo {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 90%;
  max-width: 600px;
  margin: 1vh 0;
  padding: 0.5em 1em;
  background: #f8f8f8;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: bold;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  box-sizing: border-box;
}

#gameInfo span {
  flex: 1;
  text-align: center;
}

#gameInfo {
  background: transparent;
  box-shadow: none;
  margin-top: 1vh;
  margin-bottom: 1vh;
}

/* =========================
   2. Game Container and Board
========================= */
#gameContainer {
  display: none;
  z-index:20;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;  /* space things evenly */
  
  width: 90vw;        /* consistent width */
  max-width: 600px;   /* keeps it neat on desktop */
  height: 90vh;       /* always fits on screen */
  max-height: 100vh;
  position: relative;
  border-radius: 3%;
  background: #fff;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2),
              0 -6px 14px rgba(255,255,255,0.8);
  padding: 1vh;
  box-sizing: border-box;
  overflow: hidden;   /* prevent scrollbars popping in */
}


/*#boardWrap {
  position: absolute;
  top: 15%;
  bottom: 15%;
  left: 5%;
  right: 5%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}*/

#innerBoard {
  margin-top: 3vh;  
  flex: 1 1 auto;
  aspect-ratio: 1 / 1;
  max-width: 100%;
  max-height: 70vh; /* keep space for player */

/*Grid Attributes*/
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  grid-template-rows: repeat(8, 1fr);
  gap: 0.75%;
  padding: 2%;
  
  
  border-radius: 3%;
  background: #e6e6e6;
  box-shadow: inset 0 2.5% 5% rgba(0,0,0,0.18),
              inset 0 -1.5% 3% rgba(0,0,0,0.08);
  box-sizing: border-box;
}


/* =========================
   3. Main Menu
========================= */
#mainMenu {
  position: relative;
  z-index: 20;
  aspect-ratio: 9 / 16;
  min-height: 500px;
  max-height: 650px;
  border-radius: 18px;
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18), 0 -6px 12px rgba(255, 255, 255, 0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 30px 20px;
  box-sizing: border-box;
  margin: 0 auto;
  gap: 16px;
  overflow: hidden;
}

#mainMenu h1, #mainMenu h2 {
  margin: 0;
  line-height: 1.1;
  color: var(--pink);
  letter-spacing: 1px;
  text-align: center;
  top: 5%;
}

#mainMenu .menuBtn {
  border-radius: 999px;
  font-size: 1.2rem; /* default font size for buttons */
  padding: 12px 24px; /* default padding */
  border: none;
  background-color: var(--pink);
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

#mainMenu .menuBtn:hover {
  background: #ff1a75; /* brighter pink like the title hover */
  color: #dark-pink;
  text-shadow: 0 0 15px #ff99cc, 0 0 25px #ff4da6; /* glow like title */
  animation: popBounce 0.4s ease; /* bounce animation */
  box-shadow: 0 0 12px 4px rgba(255, 77, 166, 0.6);
}

@media (max-width: 768px) {
  #mainMenu {
    height: 80vh; /* Slightly reduce height for medium screens */
    padding: 50px 16px;
    gap: 14px;
  }

  #mainMenu .menuBtn {
    font-size: 1rem; /* smaller font size for medium screens */
    padding: 10px 20px; /* slightly reduced padding */
  }

  #mainMenu .menuBtn {
    width: 80%; /* make buttons stretch across the width on medium screens */
  }
}

@media (max-width: 400px) {
  #mainMenu {
    height: 75vh;
    padding: 40px 16px;
    gap: 12px;
  }

  #mainMenu .menuBtn {
    font-size: 0.9rem; /* smaller font size for smaller screens */
    padding: 8px 12px; /* reduce padding for smaller screens */
  }

  #mainMenu .menuBtn {
    width: 90%; /* buttons take almost full width on small screens */
  }

  #gameTitle span {
    font-size: 1.5rem; /* adjust game title size */
  }
}



/* =========================
   4. Buttons
========================= */
.menuBtn {
  width: 100%;                  /* fill container width */
  max-width: 320px;             /* optional max width */
  padding: clamp(0.5rem, 1.5vw, 1rem);  /* scale padding */
  border-radius: 999px;
  border: none;
  background: var(--pink);
  color: white;
  font-weight: 700;
  font-size: clamp(12px, 3vw, 18px);   /* responsive font size */
  cursor: pointer;
  transition: transform 0.12s ease, background 0.12s;
  box-sizing: border-box;
}

.menuBtn:hover {
  background: #ff80c0;
  transform: translateY(-2px);
}

/* Responsive adjustments for very small screens */
@media (max-width: 360px) {
  #mainMenu {
    width: 95vw;
    padding: 1rem 0.5rem;
    gap: 0.5rem;
  }

  .menuBtn {
    font-size: clamp(10px, 4vw, 16px);
    padding: 0.4rem 0.6rem;
  }
}

.btn-candy {
  border: none;
  border-radius: 50%;
  width: clamp(30px, 4vmin, 40px);  
  height: clamp(30px, 4vmin, 40px);
  font-size: clamp(8px, 2vmin, 15px);
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: var(--pink);
  color: white;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.btn-candy:hover {
  transform: scale(1.1);
}
.btn-candy:active {
  transform: scale(0.95);
}

#toggleMusicBtn {
  position: absolute;
  top: 0;
  right: 0;
  border-radius: 0 0 0 12px ;
  height:4%;
  padding: 0.5em 1em; 
  border: 0;
  background: var(--pink);
  color: white;
  font-weight: 700;
  font-size: clamp(5px, 2.5vw, 12px);
  cursor: pointer;
  transition: background 0.3s;
  
  display: flex;            
  justify-content: center; 
  align-items: center;     
  text-align: center;       
}

#backButton {
  position: absolute;
  top: 0;
  left: 0;
  border-radius: 0 0 12px 0;
  height:4%;
  padding: 0.5em 1em; 
  border: 0;
  background: var(--pink);
  color: white;
  font-weight: 700;
  font-size: clamp(5px, 2.5vw, 12px);
  cursor: pointer;
  transition: background 0.3s;
  
  display: flex;            
  justify-content: center; 
  align-items: center;     
  text-align: center;       
}

#backButton:hover {
  background: #ff80c0;
}

#mechanicsButton {
  bottom: 3%;
  align-items: center;
  border-radius: 12px 0 12px 0;
  height:4%;
  padding: 0.5em 1em; 
  border: 0;
  background: var(--pink);
  color: white;
  font-weight: 700;
  font-size: clamp(5px, 2.5vw, 12px);
  cursor: pointer;
  transition: background 0.3s;
  
  display: flex;            
  justify-content: center; 
  align-items: center;     
  text-align: center;       
}


/* =========================
   5. Tiles and Animations
========================= */
.tile {
  -ms-touch-action: none;
  -webkit-user-select: none;
  touch-action: none;
  background: white;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  cursor: pointer;
  user-select: none;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}
.tileImg {
  width: 100%;
  height: 100%;
  border-radius: 10px;
  object-fit: cover;
}

.tile.matching { animation: matchPop 0.4s ease forwards !important;}
@keyframes matchPop { 0%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:.8;}100%{transform:scale(0);opacity:0;} }

.tile.dizzyChange { animation: dizzyPop 0.4s ease forwards; }
@keyframes dizzyPop {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.15); opacity: 0.6; }
  100% { transform: scale(0); opacity: 0; }
}


.tile.selected { box-shadow: 0 0 16px 6px rgba(135,206,250,0.8); }
.tile.shake { animation: shake 0.25s ease; }
@keyframes shake {0%,100%{transform:translateX(0);}25%{transform:translateX(-4px);}50%{transform:translateX(4px);}75%{transform:translateX(-2px);}}

@keyframes hoverPulse { 0%{box-shadow:0 0 6px 1px rgba(135,206,250,0.4);}50%{box-shadow:0 0 10px 2px rgba(135,206,250,0.6);}100%{box-shadow:0 0 6px 1px rgba(135,206,250,0.4);} }
@keyframes glowPulse { 0%{box-shadow:0 0 10px 2px rgba(135,206,250,0.6);}50%{box-shadow:0 0 16px 4px rgba(135,206,250,0.9);}100%{box-shadow:0 0 10px 2px rgba(135,206,250,0.6);} }

.tile:hover, .tile.selected { transform: scale(1.06); box-shadow: 0 0 12px 4px rgba(135,206,250,0.6); }
.tile:hover { animation: hoverPulse 0.6s infinite ease-in-out; }
.tile.selected { animation: glowPulse 1s infinite ease-in-out; }

/* =========================
   6. Floating Candies
========================= */
#floatingCandies {
  position: fixed;
  top: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  overflow: hidden;
  z-index: 15;
}
.floating-candy {
  position: absolute;
  top: 5%;
  width: clamp(20px, 5vw, 50px);
  height: clamp(20px, 5vw, 50px);
  pointer-events: none;
  z-index: 10;
}
@keyframes rise {0%{transform:translate(0,100vh);opacity:0;}20%{opacity:1;}50%{transform:translate(20px,50vh);}100%{transform:translate(-10px,-50px);opacity:0;}}
@keyframes fall {0%{transform:translate(0,-50px);opacity:0;}20%{opacity:1;}50%{transform:translate(-15px,50vh);}100%{transform:translate(10px,100vh);opacity:0;}}

/* =========================
   7. Score, Timer, Moves and Mode Display
========================= */
#timerDisplay, #scoreDisplay, #movesDisplay, #modeDisplay {
  position: absolute;
  font-weight: 800;
  font-size: clamp(5px, 3vw, 18px);
  color: var(--pink);
  z-index: 5;
  text-align: center;
}


#timerDisplay { left: 5%; }
#scoreDisplay { right: 5%; }
#movesDisplay { left: 5%; }
#modeDisplay { left: 50%; transform: translateX(-50%); }

.time-warning {
  color: white !important;
  -webkit-text-stroke: 1px red;
  text-stroke: 1px white;
  animation: pulseGlow 1s infinite;
}
@keyframes pulseGlow {0%{transform:scale(1);text-shadow:0 0 4px red,0 0 6px red;}50%{transform:scale(1.1);text-shadow:0 0 12px red,0 0 18px red;}100%{transform:scale(1);text-shadow:0 0 4px red,0 0 6px red;}}

/* =========================
   8. Music Player
========================= */

#musicPlayerBox {   
  display: none;
  width: 90%;
  max-width: 600px;
  height: 50vmin;
  max-height: 120px;
  aspect-ratio: 4 / 1
  align-items: center;
  border-radius: 20px;
  background: #fff;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2), 0 -6px 14px rgba(255,255,255,0.8);
  padding: 1em;
  flex-direction: column;
  gap: 0.5em;
  z-index: 25;
  box-sizing: border-box;
  margin: 0 0 4vh 0;
  justify-content:center;
}
/*
#extraBox,#musicPlayerBox {   
  display: none;
  width: 90%;
  max-width: 600px;
  height: 50vmin;
  max-height: 130px;
  aspect-ratio: 4 / 1
  align-items: center;
  border-radius: 20px;
  background: #fff;
  box-shadow: 0 12px 30px rgba(0,0,0,0.2), 0 -6px 14px rgba(255,255,255,0.8);
  padding: 1em;
  flex-direction: column;
  gap: 0.5em;
  z-index: 25;
  border-radius: 20px;
  box-sizing: border-box;
  margin: 0 0 4vh 0; 
}*/

#playerWrapper {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: stretch; /* make them equal in height too */
  gap: 1rem;
  width: 100%;
  max-height: 130px;
  max-width: 800px;
  margin: 0 auto;
}

/* Small screens */
@media (max-width: 400px) {
  #musicPlayerBox {
    max-height: 120px;     /* smaller max height for mobile */
  }
}

#youtubePlayerContainer { display:none; height:0; width:0; overflow:hidden; }
#youtubePlayer { border:none; width:100%; height:100%; }


.progress {
  height: clamp(6px, 0.6vw, 8px);
  margin: clamp(1%, 1vw, 1%) 0;
  border-radius: 4px;
  background: #ffb6c1;
  cursor: pointer;
  position: relative;
}

#progressBar {
  height: 100%;
  background: #ff4da6;
  border-radius: 4px;
  transition: width 0.1s linear;
}

#progressKnob {
  position: absolute;
  top: 50%;
  width: 12px;
  height: 12px;
  background: white;
  border: 2px solid #ff4da6;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}


.music-box { width: 100%; background: #fff; border-radius: 16px; padding: 0; text-align: center; }
.btn-circle {
  border-radius: 50%;
  width: clamp(40px,6vmin,60px);
  height: clamp(40px,6vmin,60px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(14px,2vmin,22px);
  margin: 1vmin;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.btn-circle:hover { transform: scale(1.1); }

#volumeSlider {
  -webkit-appearance: none;
  max-width: 50px; /* fixed width to prevent zoom scaling */
  height: 0.5rem;
  border-radius: 999px;
  background: linear-gradient(90deg, #ff4da6, #ffb6c1);
  outline: none;
  transition: box-shadow 0.2s ease;
}

#volumeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 1.2rem;
  height: 1.2rem;
  border-radius: 50%;
  background: white;
  border: 2px solid #ff4da6;
  cursor: pointer;
  transition: transform 0.15s ease;
}

#volumeSlider:hover::-webkit-slider-thumb {
  transform: scale(1.1);
}

#volumeSlider:focus::-webkit-slider-thumb {
  box-shadow: none;
  background: white;
  border: 2px solid #ff4da6;
}
.dropup {
  position: relative; /* anchor for absolute dropdown */
  width: 100%;        /* keeps it aligned with button */
}

.dropup .dropdown-menu {
  width: 100%;
  max-width: 80%;
  max-height: 200px;
  border-radius: 0.5em;
  overflow-y: auto;
  overflow-x: hidden;
  background: #1c1c1c;

  /* prevent shifting */
  margin: 0;
  position: absolute; 
  left: 0;
}


.dropup .dropdown-item {
  color: #ff69b4;
  font-size: clamp(0.9rem, 1vw, 1rem);
  background: transparent;
  transition: background 0.2s, color 0.2s;
}

.dropup .dropdown-item:hover,
.dropup .dropdown-item:focus {
  background: #ff69b4;
  color: #1c1c1c;
}

/* Optional scroll bar */
.dropup .dropdown-menu::-webkit-scrollbar {
  width: 8px;
}
.dropup .dropdown-menu::-webkit-scrollbar-track {
  background: #1c1c1c;
  border-radius: 8px;
}
.dropup .dropdown-menu::-webkit-scrollbar-thumb {
  background-color: #ff69b4;
  border-radius: 8px;
  border: 2px solid #1c1c1c;
}

.dropup .dropdown-menu.show {
  width: 120% !important;  /* make it wider */
  max-width: none;
}

.dropup .dropdown-toggle {
  width: 90%;
  max-width: 90%;
  display: flex;
  border-radius: 0.5em;
  justify-content: center;   /* center the title */
  align-items: center;
  position: relative;        /* needed for absolute arrow */
  margin: 0 auto;            /* center button inside container */
  text-align: center;
}

.dropup .dropdown-toggle::after {
  position: absolute;
  right: 12px;               /* push arrow to far right */
  margin-left: 0;            /* reset Bootstrap default */
}

/* Pink border for the dropup button */
.btn-outline-secondary.dropdown-toggle {
  font-size: clamp(12px, 2.5vw, 16px);
  padding: 0.25em 0.5em;
  white-space: nowrap;
  border-color: #ff69b4;      
  color: #ff69b4;            
  background: transparent;      
  transition: all 0.2s;
}

.btn-outline-secondary.dropdown-toggle:hover,
.btn-outline-secondary.dropdown-toggle:focus {
  background-color: #ff69b4;  
  color: #1c1c1c;              
  border-color: #ff69b4;      
}

#songTitle {
    width: 80%;                           
    max-width: 400px;                     
    font-size: clamp(12px, 1.5vw, 16px);  
    margin: 1% auto 0 auto;
    text-align: left;
    border-radius: 0.5em;
    background: #f5f5f5;
    height: 3em;                
    line-height: 3em;            
    min-height: 2em;                      
    overflow: hidden;                     
    white-space: nowrap;                   
    text-overflow: ellipsis;

	display: flex;             /* flexbox centering */
    align-items: center;       /* vertical center */
    justify-content: left;   /* horizontal center */	
}

.music-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: clamp(8px, 2vw, 20px); 
  margin: clamp(4px, 1vw, 12px) 0;
}

/*/* ---------------- Music Player Grid ---------------- */
.music-player-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr; /* left, center, right */
  align-items: center;
  gap: 1rem;
  width: 100%;
  max-width: 580px; /* optional max width */
  max-height: 150px;
  margin: 0 auto;
  box-sizing: border-box;
  overflow: overflow;
}

/* LEFT: Dropup */
.music-player-left {
  display: flex;
  justify-content: flex-start;
  align-items: center;
  flex-wrap: nowrap;       
  min-width: 0;
  
}

/* CENTER: Controls */
.music-player-center {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: nowrap;
  min-width: 0;
}

/* RIGHT: Volume */
.music-player-right {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 0.5rem;
  flex-wrap: nowrap;
  min-width: 0;
}

/* Make volume slider stretch a bit */
.music-player-right input[type="range"] {
  width: clamp(80px, 20vmin, 150px);  /* min, relative, max */
}

/* =========================
   9. Modals and Overlays
========================= */
.overlay {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  display:flex;
  justify-content:center;
  align-items:center;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(5px);
  z-index:9999;
}

.modal-body {
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  max-width:100%;
  margin:0 auto;
  box-sizing:border-box;
  text-align: center;
}

.modal-dialog {
  margin: auto;              /* centers horizontally */
}

/* =========================
   10. Welcome Box and Candy Text
========================= */
/* Responsive welcome box, tied to game board size */
.welcome-box {
  transform: scale(0.8);
  overflow-y:auto;
  width: min(90vw, 90vh, 600px);  
  padding: clamp(0.5rem, 2vw, 0.8rem) clamp(1rem, 4vw, 1.5rem);
  border-radius: 1rem;
  background: rgba(255, 255, 255, 0.9);
  text-align: center;
  display: flex;
  max-height: 70vh;
  flex-direction: column;
  align-items: center;
  margin: auto;                   
  box-sizing: border-box;
}

.welcome-box h1 {
  font-size: clamp(1.2rem, 4vw, 2rem);  
}

.welcome-box h2 {
  font-size: clamp(1rem, 3.5vw, 1.5rem);
  line-height: 1.4;
  margin: 0.5em 0;
}

.welcome-box p {
  font-size: clamp(0.85rem, 3vw, 1.1rem);/
  line-height: 1.4;
  margin: 0.5em 0;
}



/* Responsive images */
.welcome-box img {
  max-width: 80%;
  height: auto;
  border-radius: 12px;
}

.candy-animation {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:0.5rem;
  margin:1rem 0;
}

.welcome-box button {
  font-size: clamp(0.9rem, 2.8vw, 1.05rem);  /* smaller button text */
  padding: clamp(0.4rem, 1.8vw, 0.7rem) clamp(0.8rem, 3.5vw, 1.2rem);
  border-radius: 0.6rem;               /* rounded corners */
  border: none;
  background: #ff6f91;                     /* example: pinkish theme */
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.3s ease;
  width: fit-content;                      /* shrink to content */
  max-width: 80%;
  margin: 0.5em 0;  /* don’t overflow */
}

/* Hover / tap effect */
.welcome-box button:hover {
  transform: scale(1.05);
  background: #ff4f70;
}

#saveNameBtn {
  font-size: clamp(0.9rem, 2.8vw, 1.05rem);  /* smaller button text */
  padding: clamp(0.4rem, 1.8vw, 0.7rem) clamp(0.8rem, 3.5vw, 1.2rem);
  border-radius: 0.6rem;               /* rounded corners */
  border: none;
  background: #ff6f91;                     /* example: pinkish theme */
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: transform 0.2s ease, background 0.3s ease;
  width: fit-content;                      /* shrink to content */
  max-width: 80%;
  margin: 0.5em 0;  /* don’t overflow */
}

/* Hover / tap effect */
#saveNameBtn:hover {
  transform: scale(1.05);
  background: #ff4f70;
}




.candy-img { width:clamp(30px,5vw,50px); height:clamp(30px,5vw,50px); }

.candy-text {
  font-size: clamp(40px, 10vw, 80px);
  color: #ff4da6;
  margin: 5px 0;
  text-align: center;
}
.candy-text span {
  display:inline-block;
  cursor:pointer;
  transition: color 0.3s ease, text-shadow 0.3s ease;
}
.candy-text span:hover {
  color:#ff1a75;
  text-shadow:0 0 15px #ff99cc,0 0 25px #ff4da6;
  animation: popBounce 0.4s ease;
}

@keyframes popBounce {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.15); }
  60%  { transform: scale(0.95); }
  80%  { transform: scale(1.05); }
  100% { transform: scale(1); }
}
.candy-animation {
  display: flex;
  gap: 10px;
}

.candy {
  font-size: 28px;
  display: inline-block;
  animation: bounceCandy 1s infinite ease-in-out;
}

.candy-img {
   width: clamp(30px, 5vw, 50px);
}

.candy:nth-child(1) { animation-delay: 0s; }
.candy:nth-child(2) { animation-delay: 0.1s; }
.candy:nth-child(3) { animation-delay: 0.2s; }
.candy:nth-child(4) { animation-delay: 0.3s; }
.candy:nth-child(5) { animation-delay: 0.4s; }
.candy:nth-child(6) { animation-delay: 0.5s; }
.candy:nth-child(7) { animation-delay: 0.6s; }
.candy:nth-child(8) { animation-delay: 0.7s; }

@keyframes bounceCandy {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px) rotate(-10deg); }
}
#mechanicsModal .modal-dialog {
  max-width: 800px; /* adjust width as needed */
  width: 90%;       /* responsive for smaller screens */
}
  
  @keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-28px); opacity: 0; }
  }
  
:root{
  --fade-out-dur: 500ms;
  --fade-in-dur: 600ms;
}

/* =========================
   11. Miscellaneous
========================= */

#shuffleOverlay {
  position:absolute;
  top:0; left:0; width:100%; height:100%;
  backdrop-filter: blur(6px);
  background: rgba(255,255,255,0.5);
  display:flex; justify-content:center; align-items:center;
  font-size:1.8rem; font-weight:700; color:var(--pink);
  z-index:50; border-radius:14px; text-align:center; padding:10px;
  opacity:0; pointer-events:none; transition:opacity 0.3s ease;
}

.floating-score {
  position:absolute; font-weight:800; color:var(--pink); font-size:20px;
  pointer-events:none; animation: floatUp 0.8s ease forwards;
  text-shadow:0 0 6px #fff, 0 0 10px #ff4da6;
}
@keyframes floatUp {0%{transform:translateY(0) scale(1);opacity:1;}50%{transform:translateY(-20px) scale(1.3);opacity:1;}100%{transform:translateY(-40px) scale(1);opacity:0;}}



/* Credits */
.credit-img {
  width: 60px;
  border-radius: 50%;
  margin-bottom: 0.5rem;
}

@keyframes popIn {
  0% { transform: scale(0) rotate(-30deg); opacity: 0; }
  50% { transform: scale(1.3) rotate(10deg); opacity: 1; }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}

.candy-text.animate span {
  display: inline-block;
  color: #ff1a75; text-shadow: 0 0 15px #ff99cc, 0 0 25px #ff4da6;
  animation: popIn 1s forwards;
}

/* Delay each letter for wave effect */
.candy-text.animate span:nth-child(1) { animation-delay: 0s; }
.candy-text.animate span:nth-child(2) { animation-delay: 0.05s; }
.candy-text.animate span:nth-child(3) { animation-delay: 0.1s; }
.candy-text.animate span:nth-child(4) { animation-delay: 0.15s; }
.candy-text.animate span:nth-child(5) { animation-delay: 0.2s; }
.candy-text.animate span:nth-child(6) { animation-delay: 0.25s; }
.candy-text.animate span:nth-child(7) { animation-delay: 0.3s; }
.candy-text.animate span:nth-child(8) { animation-delay: 0.35s; }
.candy-text.animate span:nth-child(9) { animation-delay: 0.4s; }


.random-pop {
  display: inline-block;
  color: #ff1a75;
  animation: bounceCandy 0.4s ease;
}



    /* Font classes */
    .chewy    { font-family: 'Chewy', cursive; }
    .luckiest { font-family: 'Luckiest Guy', cursive; }
    .fredoka  { font-family: 'Fredoka One', cursive; }
    .baloo    { font-family: 'Baloo 2', cursive; }
    .bangers  { font-family: 'Bangers', cursive; }
    .bubble   { font-family: 'Bubblegum Sans', cursive; }


/* fade out (shrink + fade) */
@keyframes fadeOut {
  from { opacity: 1; transform: scale(1); filter: none; }
  to   { opacity: 0; transform: scale(0.6); filter: none; }
}
.fading-out {
  animation: fadeOut var(--fade-out-dur) forwards;
  transform-origin: center center;
  pointer-events: none; /* avoid clicks while animating */
}

/* fade in with glow pulse */
@keyframes fadeInGlow {
  0%   { opacity: 0; transform: scale(1.15); filter: drop-shadow(0 0 18px rgba(255,85,170,1)); }
  60%  { opacity: 1; transform: scale(0.98); filter: drop-shadow(0 0 10px rgba(255,120,190,0.8)); }
  100% { opacity: 1; transform: scale(1); filter: none; }
}
.fading-in {
  animation: fadeInGlow var(--fade-in-dur) forwards;
  transform-origin: center center;
  pointer-events: auto;
}

@keyframes glowPulse {
  0% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
  50% { box-shadow: 0 0 16px 4px rgba(135, 206, 250, 0.9); }
  100% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
}

@keyframes hoverPulse {
  0% { box-shadow: 0 0 6px 1px rgba(135, 206, 250, 0.4); }
  50% { box-shadow: 0 0 10px 2px rgba(135, 206, 250, 0.6); }
  100% { box-shadow: 0 0 6px 1px rgba(135, 206, 250, 0.4); }
}

/* SCROLL UI */
/* Ensure welcome-box scrolls */
.welcome-box {
  max-height: 80vh;                /* adjust if needed */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* smooth scroll on iOS */
}

/* Chrome, Edge, Safari */
.welcome-box::-webkit-scrollbar {
  width: 6px; /* very slim */
}

.welcome-box::-webkit-scrollbar-track {
  background: transparent; /* no track background */
}

.welcome-box::-webkit-scrollbar-thumb {
  background-color: rgba(0,0,0,0.3); /* subtle gray thumb */
  border-radius: 3px;
  opacity: 0;                        /* hidden by default */
  transition: opacity 0.3s;
}

.welcome-box.scrolling::-webkit-scrollbar-thumb {
  opacity: 1; /* show only while scrolling */
}

.welcome-box::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0,0,0,0.5); /* slightly darker on hover */
}

/* Firefox */
.welcome-box {
  scrollbar-width: none; /* hidden by default */
  scrollbar-color: rgba(0,0,0,0.3) transparent;
}
.welcome-box.scrolling {
  scrollbar-width: thin; /* appear thin when scrolling */
}

#youtubePlayerContainer {
  width: 100%;
  height: 120px;     /* force visible height */
  max-height: 120px;
  background: #000;  /* black background like a video frame */
}

#youtubePlayer, 
#youtubePlayer iframe {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

<!---->

</style>
</head>
<body>
<!-- Welcome Overlay -->
<div id="leaderboard"></div>
<div id="welcomeOverlay" class="overlay">
  <div class="welcome-box">
    <h2><strong>Welcome to Swicy Rush</strong></h2>
    <p>
      <strong>Swicy Rush</strong> is a fan-made puzzle game inspired by <strong>UNIS</strong>!  
      Just like the girls’ “Swicy” charm, the game is full of colorful fun, cheeky twists, and endless good vibes.  
    <br><br>
      Made by an Everafter and meant to be enjoyed by fellow Everafters, this game is our way of celebrating UNIS and sharing the joy they bring us every day.   
      <br><small>(We are not officially affiliated with UNIS or their management.)</small>
    </p>
    
    <div class="credits">
      <p><a style="color:black; text-decoration:none;" target="_blank" href="https://x.com/BaN4N4000"><img src="images/ban4n400.png" style="width:60px; height:60px;" alt="BaN4N4000"><br>
		<strong>Developed by: @BaN4N4000</a></strong>
      <br>
        Special thanks to 
        <a style="color:black; text-decoration:none;" target="_blank" href="https://x.com/_8n0nx">@_8n0nx for the UNIS Pixel Art</a>
      </p>
	<a style="color:black; text-decoration:none;" target="_blank" href="https://x.com/_8n0nx">
    <div class="candy-animation">
      <img src="images/candy1.png" class="candy-img candy" alt="Candy 1">
      <img src="images/candy2.png" class="candy-img candy" alt="Candy 2">
      <img src="images/candy3.png" class="candy-img candy" alt="Candy 3">
      <img src="images/candy4.png" class="candy-img candy" alt="Candy 4">
      <img src="images/candy5.png" class="candy-img candy" alt="Candy 5">
      <img src="images/candy6.png" class="candy-img candy" alt="Candy 6">
      <img src="images/candy7.png" class="candy-img candy" alt="Candy 7">
      <img src="images/candy8.png" class="candy-img candy" alt="Candy 8">
    </div></a>
	<button id="closeWelcome">Start Game</button>
    </div>     
  </div>
</div>

<!-- Player Name Modal -->
<div class="modal fade" id="playerNameModal" tabindex="-1" aria-labelledby="playerNameModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px; max-width:400px; margin:auto;">
      <div class="modal-header">
        <h5 class="modal-title w-100 text-center" id="playerNameModalLabel">Enter Your Name</h5>
      </div>
      <div class="modal-body text-center">
        <input id="playerNameInput" type="text" value="Guest" 
               class="form-control text-center" style="max-width:200px; margin:auto;">
      </div>
      <div class="modal-footer justify-content-center">
        <button id="saveNameBtn" type="button" class="btn btn-primary">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- LEADERBOARD -->

<div class="modal fade" id="leaderboardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title w-100 text-center">Leaderboard</h5>
      </div>
      <div class="modal-body">

        <!-- Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="leaderboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="classic-tab" data-bs-toggle="tab" data-bs-target="#classic"
              type="button" role="tab">Classic</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="hurry-tab" data-bs-toggle="tab" data-bs-target="#hurry"
              type="button" role="tab">Hurry Hurry</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="dizzy-tab" data-bs-toggle="tab" data-bs-target="#dizzy"
              type="button" role="tab">Dizzy Dizzy</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="swish-tab" data-bs-toggle="tab" data-bs-target="#swish"
              type="button" role="tab">Swish & Match</button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content mt-3" id="leaderboardTabContent">
          <div class="tab-pane fade show active" id="classic" role="tabpanel">
            <div id="leaderboard-classic">Loading...</div>
          </div>
          <div class="tab-pane fade" id="hurry" role="tabpanel">
            <div id="leaderboard-hurry">Loading...</div>
          </div>
          <div class="tab-pane fade" id="dizzy" role="tabpanel">
            <div id="leaderboard-dizzy">Loading...</div>
          </div>
          <div class="tab-pane fade" id="swish" role="tabpanel">
            <div id="leaderboard-swish">Loading...</div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>



<div id="floatingCandies"></div>
<div id="appWrapper">
<section id="mainMenu" aria-label="Main menu">
  <h2 id="gameTitle" class="candy-text bangers">
    <span>S</span><span>w</span><span>i</span><span>c</span><span>y</span> <span>R</span><span>u</span><span>s</span><span>h</span>
  </h2>
  
  <button id="classicBtn" class="menuBtn">Classic</button>
  <button id="hurryBtn" class="menuBtn">Hurry Hurry</button>
  <button id="dizzyBtn" class="menuBtn">Dizzy Dizzy</button>
  <button id="swishBtn" class="menuBtn">Swish and Match</button>
  <button id="mechanicsBtn" class="menuBtn">Mechanics</button>
  <button id="leaderBtn" class="menuBtn" data-bs-toggle="modal" data-bs-target="#leaderboardModal">Leaderboard</button>
  <P>Demo Version</P>
  
</section>


<div class="modal fade" id="mechanicsModal" tabindex="-1" aria-labelledby="mechanicsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title" id="mechanicsModalLabel">Game Mechanics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
	  <a style="color:black" target="_blank" href="https://x.com/_8n0nx">
		<div class="candy-animation d-flex justify-content-center mb-3">
			<img src="images/candy1.png" class="candy-img candy" alt="Candy 1">
			<img src="images/candy2.png" class="candy-img candy" alt="Candy 2">
			<img src="images/candy3.png" class="candy-img candy" alt="Candy 3">
			<img src="images/candy4.png" class="candy-img candy" alt="Candy 4">
			<img src="images/candy5.png" class="candy-img candy" alt="Candy 5">
			<img src="images/candy6.png" class="candy-img candy" alt="Candy 6">
			<img src="images/candy7.png" class="candy-img candy" alt="Candy 7">
			<img src="images/candy8.png" class="candy-img candy" alt="Candy 8">
		</div></a>
		
       <strong>Classic</strong>Match candies at your own pace.
       <strong>Hurry Hurry</strong> Score as much as you can before time runs out!
       <strong>Dizzy Dizzy</strong> Candies randomly shuffle, stay sharp!
       <strong>Swish and Match</strong> Match special a Special Candy and get extra move! 
	   <p></p><p></p>      
		
		
		<a style="color:black; text-decoration:none;" target="_blank" href="https://x.com/BaN4N4000"><strong>Developed By:  @BaN4N4000</a></strong>
		<a style="color:black; text-decoration:none;" target="_blank"href="https://x.com/_8n0nx"><strong>Pixel Artist:  @_8n0nx</a></strong>

      </div>
      <div class="modal-footer">
        <button id="mechanicsButton" type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>


<section id="gameWrapper">
   <div id="boardWrap">
<div id="gameContainer" aria-hidden="true">
<button id="backButton">❮❮ Back</button>
<!--  <button id="toggleMusicBtn">Music ❯❯</button> -->
  <!-- <button id="shuffleBtn" class="btn-candy">Shuffle</button> -->
<div id="shuffleOverlay">No more Tiles to Match!<br>Shuffling...</div>
  
    <div id="innerBoard" role="grid" aria-label="Game board"></div>	
	<div id="gameInfo">
	  <div id="timerDisplay">Time: ∞</div>
	  <div id="modeDisplay"></div>
	  <div id="scoreDisplay">Score: 0</div>
    </div>		

<div id="playerWrapper">
  <div id="extraBox">
    <video id="videoPlayer" controls style="display:none; width:100%; max-height:120px;"></video>
    <div id="youtubePlayerContainer" style="width:100%; max-height:120px; display:none;">
    <div id="youtubePlayer"></div></div>
</div>
</div>	

	<div id="musicPlayerBox" class="container">
			 
	  <audio id="audioPlayer" preload="auto"></audio>		
	  <!-- Progress bar -->
	
      <div class="progress">
		<div id="progressBar" class="progress-bar bg-danger" style="width: 0%;"></div>
	  </div>
		<div class="music-player-grid">
		   
		  <!-- LEFT: Dropup -->
		  <div class="music-player-left">

		    <!-- dynamically generated songs -->
		    <div class="dropup">
			  <button id="songTitle" class="btn btn-sm btn-outline-secondary dropdown-toggle"  data-bs-toggle="dropdown">
				Song List
			  </button>
			  <ul class="dropdown-menu" id="songList">
	          </ul>
		    </div>
			  
		  </div>
		    <!-- CENTER: Music Controls -->
		  <div class="music-player-center">      
				<button class="btn-candy" id="prevBtn"><i class="bi bi-skip-backward-fill"></i></button>
				<button class="btn-candy" id="playBtn"><i class="bi bi-play-fill"></i></button>
				<button class="btn-candy" id="nextBtn"><i class="bi bi-skip-forward-fill"></i></button>
		  </div>

		  <!-- RIGHT: Volume -->		 
		  <div class="music-player-right">
				<i class="bi bi-volume-down"></i>
				<input type="range" id="volumeSlider" min="0" max="100" value="70">
				<i class="bi bi-volume-up"></i>
		  </div>
		</div>
	</div>
</div>
</div>
</section>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
  const SUPABASE_URL = "https://hbpozzrizbbpycwgdywi.supabase.co";   // 🔹 Replace with your Project URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhicG96enJpemJicHljd2dkeXdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2Mzg1NTMsImV4cCI6MjA3NDIxNDU1M30.qozBD0aiQtbjwJaPFV0-35P5_T7I2VZC5I2GkDkkMls";                // 🔹 Replace with your anon public key

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script>

//shuffle tester
document.addEventListener("DOMContentLoaded", () => {
  const shuffleBtn = document.getElementById("shuffleBtn");

  if (shuffleBtn) {
    shuffleBtn.addEventListener("click", () => {
      showShuffleOverlay(800); // show overlay for 0.8s
      setTimeout(() => animateShuffleAndResolve(), 800); // wait, then animate & shuffle
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggleMusicBtn");
  const musicBox = document.getElementById("musicPlayerBox");

  toggleBtn.addEventListener("click", () => {
    if (musicBox.style.display === "none" || musicBox.style.display === "") {
      musicBox.style.display = "flex";   // or "block"
      toggleBtn.textContent = "Music ❯❯";
    } else {
      musicBox.style.display = "none";
      toggleBtn.textContent = "Music ❯❯";
    }
  });
  
  
});

const nameInput = document.getElementById("playerNameInput");

nameInput.addEventListener("focus", function () {
  if (this.value === "Guest") {
    this.value = "";   // clear it
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const nameModalEl = document.getElementById("playerNameModal");

  // Catch when the modal is hidden (closed by button, outside click, or Esc)
  nameModalEl.addEventListener("hidden.bs.modal", () => {
    showMenu();
  });
});

let playerName = "Guest";

// When Start Game in welcome box is clicked
document.getElementById("closeWelcome").addEventListener("click", () => {
  // Hide welcome box
  document.getElementById("welcomeOverlay").style.display = "none";

  // Show name modal
  const nameModal = new bootstrap.Modal(document.getElementById('playerNameModal'));
  nameModal.show();
});

document.getElementById("saveNameBtn").addEventListener("click", () => {
  const input = document.getElementById("playerNameInput").value.trim();
  playerName = input || "Guest";

  // Hide modal
  const nameModalEl = document.getElementById('playerNameModal');
  const modal = bootstrap.Modal.getInstance(nameModalEl);
  modal.hide();

  // 🔹 Start background music
  startMusic();

  // 🔹 Trigger Swicy Rush title animation
  const gameTitle = document.getElementById("gameTitle");
  const letters = gameTitle.querySelectorAll("span");

  gameTitle.classList.add("animate");

  setTimeout(() => {
    gameTitle.classList.remove("animate");
    let lastIndex = -1;
    setInterval(() => {
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * letters.length);
      } while (
        randomIndex === lastIndex ||
        letters[randomIndex].classList.contains("random-pop")
      );
      lastIndex = randomIndex;

      const randomLetter = letters[randomIndex];
      randomLetter.classList.add("random-pop");
      setTimeout(() => {
        randomLetter.classList.remove("random-pop");
      }, 500);
    }, 800);
  }, 1500);

 
  showMenu();
});


/*

//Into Overlay as music trigger
document.addEventListener("DOMContentLoaded", () => {
  const welcomeOverlay = document.getElementById("welcomeOverlay");
  const closeBtn = document.getElementById("closeWelcome");

  closeBtn.addEventListener("click", () => {
    welcomeOverlay.style.display = "none";
  });
});

welcomeOverlay.addEventListener("click", (e) => {
  // If the clicked element (or its parent) is an <a>, don't close
  if (e.target.closest("a")) return;

  // Otherwise, close the overlay
  welcomeOverlay.style.display = "none";
});

document.addEventListener("DOMContentLoaded", () => {
  const welcomeOverlay = document.getElementById("welcomeOverlay");
  const closeBtn = document.getElementById("closeWelcome");
  const gameTitle = document.getElementById("gameTitle");
  const letters = gameTitle.querySelectorAll("span");

  closeBtn.addEventListener("click", () => {
    welcomeOverlay.style.display = "none";

    // 🔹 Play wave animation once
    gameTitle.classList.add("animate");

    // 🔹 After wave animation ends, start random popping
    setTimeout(() => {
      gameTitle.classList.remove("animate");

      let lastIndex = -1;

      setInterval(() => {
        let randomIndex;

        do {
          randomIndex = Math.floor(Math.random() * letters.length);
        } while (
          randomIndex === lastIndex ||                // not the same as last
          letters[randomIndex].classList.contains("random-pop") // not already popping
        );

        lastIndex = randomIndex;

        const randomLetter = letters[randomIndex];
        randomLetter.classList.add("random-pop");

        // remove after animation so it can trigger again
        setTimeout(() => {
          randomLetter.classList.remove("random-pop");
        }, 500);
      }, 800); // every 0.8s a random letter pops
    }, 1500); // wait until wave animation finishes
  });
});
*/

//Rise and Fall Candies
const candyImages = [
  'images/candy1.png','images/candy2.png','images/candy3.png',
  'images/candy4.png','images/candy5.png','images/candy6.png',
  'images/candy7.png','images/candy8.png'
];

function spawnCandy() {
  if (document.hidden) return;
  
  const candy = document.createElement('img');
  candy.src = candyImages[Math.floor(Math.random() * candyImages.length)];
  candy.className = 'floating-candy';

  const candyWidth = 40;
  candy.style.left = Math.random() * (window.innerWidth - candyWidth) + 'px';

  // Decide direction
  const direction = Math.random() < 0.5 ? 'fall' : 'rise';
  const duration = Math.random() * 5 + 5; // 5-10s

  candy.style.animation = `${direction} ${duration}s linear forwards`;

  document.getElementById("floatingCandies").appendChild(candy);

  // Remove after animation
  candy.addEventListener('animationend', () => candy.remove());
}
// spawn new candy every 0.3-0.7 seconds
setInterval(spawnCandy, 400);



//Possible Moves checker

function hasPossibleMoves() {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const val = board[r][c];

      // Check swap with right neighbor
      if (c < COLS - 1) {
        [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
        if (findAllMatches().length > 0) {
          [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
          return true;
        }
        [board[r][c], board[r][c + 1]] = [board[r][c + 1], board[r][c]];
      }

      // Check swap with bottom neighbor
      if (r < ROWS - 1) {
        [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
        if (findAllMatches().length > 0) {
          [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
          return true;
        }
        [board[r][c], board[r + 1][c]] = [board[r + 1][c], board[r][c]];
      }
    }
  }
  return false;
}

//Tile Shuffler
function shuffleBoard() {
  // Flatten board, shuffle array, then rebuild 2D board
  const flat = board.flat();
  for (let i = flat.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [flat[i], flat[j]] = [flat[j], flat[i]];
  }

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      board[r][c] = flat[r * COLS + c];
    }
  }

  renderWholeBoard();
}

function animateShuffleAndResolve() {
  const FADE_OUT_MS = 500; 
  const FADE_IN_MS  = 600; 
  const BUFFER_MS   = 20;  
 
  const tiles = Array.from(innerBoard.querySelectorAll('.tile'));

  if (tiles.length === 0) {
    shuffleBoard();
    
    setTimeout(() => resolveMatchesAndCascade(false), 50);
    return;
  }

  
  tiles.forEach(tile => {
    
    tile.classList.remove('matching','shake','selected','random-pop','scrambling','fading-in');
    tile.classList.add('fading-out');
  });

  setTimeout(() => {
  
    shuffleBoard();

    const newTiles = Array.from(innerBoard.querySelectorAll('.tile'));
    newTiles.forEach(t => {
      t.style.opacity = 0;
      void t.offsetWidth;
      t.classList.add('fading-in');
    });

    setTimeout(() => {
      newTiles.forEach(t => {
        t.classList.remove('fading-in');
        t.style.opacity = '';
      });
      resolveMatchesAndCascade(false);
    }, FADE_IN_MS + BUFFER_MS);

  }, FADE_OUT_MS + BUFFER_MS);
}


function showShuffleOverlay(duration = 1000) {
  const overlay = document.getElementById('shuffleOverlay');
  overlay.style.opacity = 1;

  setTimeout(() => {
    overlay.style.opacity = 0;
  }, duration);
}


const mechanicsBtn = document.getElementById("mechanicsBtn");
const mechanicsModal = new bootstrap.Modal(document.getElementById('mechanicsModal'));

mechanicsBtn.addEventListener("click", () => {
  mechanicsModal.show();
});


const ROWS = 8, COLS = 8;
const IMAGE_PREFIX = 'images/candy';
const BONUS_IMAGE = 'images/bonuscandy.png';

const bonusSound = new Audio("sounds/soundeffects/kwengkweng.MP3");
bonusSound.volume = 1; 

const matchSound = new Audio("sounds/soundeffects/sfx2.mp3");
matchSound.volume = 1; 

const hurryBonusSound = new Audio("sounds/soundeffects/sfx1.mp3");
hurryBonusSound.volume = 1; 

const invalidMatchSound = new Audio('sounds/soundeffects/sfx3.mp3');
const timeUpSound = new Audio('sounds/soundeffects/sfx4.mp3');
const noMovesLeftSound = new Audio('sounds/soundeffects/sfx4.mp3');


let board = [], score = 0, firstSelection = null, dragSource = null;
let mode = null, movesLeft = 0, timerValue = 0;
let timerInterval = null, dizzyInterval = null;

const mainMenu = document.getElementById('mainMenu');
const gameContainer = document.getElementById('gameContainer');
const innerBoard = document.getElementById('innerBoard');
const scoreDisplay = document.getElementById('scoreDisplay');
const timerDisplay = document.getElementById('timerDisplay');

function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }
function randomCandyValue(){ return (mode === 'Swish and Match') ? randInt(1, 9) : randInt(1, 8); }
function createTileElement(r, c, val) {
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.dataset.r = r;
  tile.dataset.c = c;

  tile.draggable = true;

  const img = document.createElement('img');
  img.className = 'tileImg';
  img.src = (val === 9) ? BONUS_IMAGE : `${IMAGE_PREFIX}${val}.png`;
  tile.appendChild(img);


  let ghost = null;
  let touchData = null;

  tile.addEventListener('touchstart', function (e) {
    e.preventDefault();
    if (isResolving) return;
    const touch = e.changedTouches[0];
    const rect = tile.getBoundingClientRect();

    ghost = tile.cloneNode(true);
    ghost.style.position = "fixed";
    ghost.style.left = rect.left + "px";
    ghost.style.top = rect.top + "px";
    ghost.style.width = rect.width + "px";
    ghost.style.height = rect.height + "px";
    ghost.style.zIndex = 9999;
    ghost.style.opacity = 0.8;
    ghost.style.pointerEvents = "none";
    document.body.appendChild(ghost);

    touchData = {
      id: touch.identifier,
      offsetX: touch.clientX - rect.left,
      offsetY: touch.clientY - rect.top,
      r, c
    };
  }, { passive: false });

  tile.addEventListener('touchmove', function (e) {
    if (!touchData) return;
    const touch = [...e.changedTouches].find(t => t.identifier === touchData.id);
    if (!touch) return;

    ghost.style.left = (touch.clientX - touchData.offsetX) + "px";
    ghost.style.top = (touch.clientY - touchData.offsetY) + "px";
    e.preventDefault();
  }, { passive: false });

  function endTouch(e) {
    if (!touchData) return;
    const touch = [...e.changedTouches].find(t => t.identifier === touchData.id);
    if (!touch) return;

    if (ghost) ghost.remove();
    ghost = null;

    const elUnder = document.elementFromPoint(touch.clientX, touch.clientY);
    const targetTile = elUnder ? elUnder.closest('.tile') : null;

    if (targetTile && targetTile.dataset.r !== undefined) {
      const tr = parseInt(targetTile.dataset.r, 10);
      const tc = parseInt(targetTile.dataset.c, 10);
      const sr = touchData.r, sc = touchData.c;

      if (areAdjacent({ r: sr, c: sc }, { r: tr, c: tc })) {
        swapAndResolve({ r: sr, c: sc }, { r: tr, c: tc });
      }
    }

    touchData = null;
  }

  tile.addEventListener('touchend', endTouch, { passive: false });
  tile.addEventListener('touchcancel', endTouch, { passive: false });

 
  tile.addEventListener('dragstart', (e) => {
    dragSource = { r, c };
  });

  tile.addEventListener('dragover', (e) => {
    e.preventDefault(); // must prevent default to allow drop
  });

  tile.addEventListener('drop', (e) => {
    const tr = parseInt(tile.dataset.r, 10);
    const tc = parseInt(tile.dataset.c, 10);
    onTileDrop(tr, tc);
  });

  // Also keep click-to-select behavior
  tile.addEventListener('click', () => onTileClick(r, c));

  return tile;
}



function spawnFloatingScore(r, c, points) {
  const tile = tileDomAt(r, c);
  if(!tile) return;

  const tileRect = tile.getBoundingClientRect();
  const boardRect = gameContainer.getBoundingClientRect();

  const scoreEl = document.createElement('div');
  scoreEl.className = 'floating-score';
  scoreEl.textContent = `+${points}`;

  // position relative to boardWrap
  scoreEl.style.position = 'absolute';
  scoreEl.style.left = `${tileRect.left - boardRect.left + tileRect.width/2 - 12}px`;
  scoreEl.style.top = `${tileRect.top - boardRect.top}px`;

  gameContainer.appendChild(scoreEl);

  setTimeout(() => {
    if(scoreEl.parentElement) scoreEl.parentElement.removeChild(scoreEl);
  }, 800); // animation duration
}

function createBoardInitial(){
  board = [];
  for(let r=0; r<ROWS; r++){
    const row = [];
    for(let c=0; c<COLS; c++) row.push(randomCandyValue());
    board.push(row);
  }
  renderWholeBoard();
  setTimeout(() => resolveMatchesAndCascade(true), 50);
}

function renderWholeBoard(){
  innerBoard.innerHTML = '';
  for(let r=0; r<ROWS; r++){
    for(let c=0; c<COLS; c++){
      innerBoard.appendChild(createTileElement(r, c, board[r][c]));
    }
  }
}

function tileDomAt(r,c){ return innerBoard.querySelector(`.tile[data-r="${r}"][data-c="${c}"]`); }
function areAdjacent(a,b){ return Math.abs(a.r-b.r)+Math.abs(a.c-b.c)===1; }


function updateHUD(){
  const modeDisplay = document.getElementById('modeDisplay');
  scoreDisplay.textContent = `Score: ${score}`;
  if(modeDisplay){
    modeDisplay.textContent = `${mode}`; // show current mode
  }
  	if(mode === 'Hurry Hurry'){
		const minutes = Math.floor(timerValue / 60);
		const seconds = timerValue % 60;
		timerDisplay.textContent = `Time: ${minutes}:${seconds.toString().padStart(2,'0')}`;
		
		if(timerValue <= 10){
			timerDisplay.classList.add('time-warning'); // pulse + glow
		} else {
			timerDisplay.classList.remove('time-warning');
		}
	}
  else if(mode==='Swish and Match') timerDisplay.textContent = `Moves: ${movesLeft}`;
  else if(mode==='Dizzy Dizzy'){
    timerDisplay.textContent = ''; 
  }
  else {
    timerDisplay.textContent = 'Time: ∞';
  }
}

let hurryTimerStarted = false;

function startTimer(){
  clearInterval(timerInterval);

  if(mode==='Hurry Hurry') {
    timerValue = 120; // 2 minutes in seconds
    updateHUD();       // show the correct initial time immediately
  } else {
    timerValue = 999;
    updateHUD();
  }

	timerInterval = setInterval(() => {
	  if(mode==='Hurry Hurry'){
		timerValue--;
		updateHUD();
		
		if(timerValue <= 0){
		  timeUpSound.currentTime = 0;
		  timeUpSound.play(); 
		  clearInterval(timerInterval); 		  
		  setTimeout(() => gameOver('Time is up!'), 500);
		}
	  }
	}, 1000); // 1000ms = 1 second
}

let isResolving = false;
function awaitAnimationEnd(el, expectedName = null) {
  return new Promise((resolve) => {
    if (!el) return resolve();
    function onEnd(e) {
      
      if (expectedName && e.animationName !== expectedName) return;
      el.removeEventListener('animationend', onEnd);
      resolve(e);
    }
    el.addEventListener('animationend', onEnd);

    setTimeout(() => {
      try { el.removeEventListener('animationend', onEnd); } catch(e) {}
      resolve();
    }, 900); 
  });
}

function updateTileAt(r, c) {
  const tile = tileDomAt(r, c);
  if (!tile) return;
  const val = board[r][c];
  const img = tile.querySelector("img");
  if (img) img.src = (val === 9) ? BONUS_IMAGE : `${IMAGE_PREFIX}${val}.png`;
}

function onTileClick(r, c){
  if (isResolving) return; 
  const clickedTile = tileDomAt(r, c);

  if(firstSelection){
    if(firstSelection.r===r && firstSelection.c===c){
      firstSelection=null;
      clickedTile.classList.remove('selected');
      return;
    }

    if(areAdjacent(firstSelection,{r,c})){
      swapAndResolve(firstSelection,{r,c});
  
	const valA = board[firstSelection.r][firstSelection.c];
	const valB = board[r][c];
	const isBonusSwap = (valA === 9 || valB === 9);
      updateHUD();

 
      tileDomAt(firstSelection.r, firstSelection.c)?.classList.remove('selected');
      clickedTile.classList.remove('selected');
    }else {

      const tileA = tileDomAt(firstSelection.r, firstSelection.c);
      const tileB = tileDomAt(r, c);
      tileA?.classList.add('shake');
      tileB?.classList.add('shake');
      setTimeout(() => {
        tileA?.classList.remove('shake');
        tileB?.classList.remove('shake');
      }, 250);
    }	
    firstSelection=null;
  } else {
    firstSelection={r,c};
    clickedTile.classList.add('selected'); // keep glow when selected
  }
}

function onTileDrop(r, c) {
  if (isResolving) return;
  if (dragSource) {
    if (areAdjacent(dragSource, { r, c })) {
      swapAndResolve(dragSource, { r, c });
	  const valA = board[dragSource.r][dragSource.c];
	  const valB = board[r][c];
	  const isBonusSwap = (valA === 9 || valB === 9);
      updateHUD();
    } else {
      const tileA = tileDomAt(dragSource.r, dragSource.c);
      const tileB = tileDomAt(r, c);
      tileA?.classList.add('shake');
      tileB?.classList.add('shake');
      setTimeout(() => {
        tileA?.classList.remove('shake');
        tileB?.classList.remove('shake');
      }, 250);
    }
  }
  dragSource = null;
}

async function swapAndResolve(a, b) {
  if (isResolving) return;
  isResolving = true;

  // swap in memory, update the two tiles visually
  [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
  updateTileAt(a.r, a.c);
  updateTileAt(b.r, b.c);

  const matches = findAllMatches();
  if (matches.length === 0) {
    // invalid swap: brief delay so user sees swap, then revert + shake
    await new Promise(r => setTimeout(r, 160));
    invalidMatchSound.currentTime = 0;
    invalidMatchSound.play();

    // revert in memory and update visuals
    [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
    updateTileAt(a.r, a.c);
    updateTileAt(b.r, b.c);

    const tileA = tileDomAt(a.r, a.c);
    const tileB = tileDomAt(b.r, b.c);
    tileA?.classList.add('shake');
    tileB?.classList.add('shake');

    // wait for shake animation to finish (fallback timeout)
    await Promise.all([
      awaitAnimationEnd(tileA, 'shake').catch(()=>{}),
      awaitAnimationEnd(tileB, 'shake').catch(()=>{})
    ]);

    tileA?.classList.remove('shake');
    tileB?.classList.remove('shake');

    isResolving = false;
  } else {
    // there are matches => resolve normally (pass true: player move)
    await resolveMatchesAndCascade(true, true);
    // resolveMatchesAndCascade will unlock isResolving after done
  }
}

function findAllMatches(){
  const matched = [];
  for(let r=0;r<ROWS;r++){
    let runVal=board[r][0], runCount=1;
    for(let c=1;c<COLS;c++){
      if(board[r][c]===runVal) runCount++;
      else {
        if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r, c:c-1-k});
        runVal=board[r][c]; runCount=1;
      }
    }
    if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r, c:COLS-1-k});
  }
  for(let c=0;c<COLS;c++){
    let runVal=board[0][c], runCount=1;
    for(let r=1;r<ROWS;r++){
      if(board[r][c]===runVal) runCount++;
      else{
        if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r:r-1-k,c});
        runVal=board[r][c]; runCount=1;
      }
    }
    if(runCount>=3) for(let k=0;k<runCount;k++) matched.push({r:ROWS-1-k,c});
  }
  const seen = new Set(), unique = [];
  for(const m of matched){
    const key = `${m.r},${m.c}`;
    if(!seen.has(key)){seen.add(key); unique.push(m);}
  }
  return unique;
}

async function resolveMatchesAndCascade(initialFlag, isPlayerMove = false) {
  // Note: we keep a guard to avoid concurrent entry
  if (isResolving === false) isResolving = true;

  let matches = findAllMatches();
  if (matches.length === 0) {
    isResolving = false;
    return;
  }

  // add matching class and mark tile busy (so dizzy won't touch it)
  const tiles = [];
  matches.forEach(pos => {
    const t = tileDomAt(pos.r, pos.c);
    if (t) {
      t.dataset.busy = 'true';
      t.classList.add('matching');
      tiles.push({el: t, pos});
    }
  });

  // wait until all matching animations end (matchPop)
  await Promise.all(tiles.map(t => awaitAnimationEnd(t.el, 'matchPop').catch(()=>{})));

  // clear matched tiles and award score
  const matchedValues = [];
  let suppressMatchSound = false;

  matches.forEach(pos => {
    // guard in case board was already cleared
    if (board[pos.r][pos.c] == null) return;
    const val = board[pos.r][pos.c];
    matchedValues.push(val);

    score += 10;
    spawnFloatingScore(pos.r, pos.c, 10);

    board[pos.r][pos.c] = null;
  });

  // Hurry Hurry time bonus logic (unchanged)
  if (mode === 'Hurry Hurry') {
    const scoreBonus = Math.floor(score / 150) * 10;
    const previousBonus = Math.floor((score - matches.length * 10) / 150) * 10;
    const addedTime = scoreBonus - previousBonus;
    if (addedTime > 0) {
      timerValue += addedTime;
      hurryBonusSound.currentTime = 0;
      hurryBonusSound.play();
      suppressMatchSound = true;
    }
  }

  if (matches.length > 0 && !suppressMatchSound) {
    matchSound.currentTime = 0;
    matchSound.play();
  }

  // Swish & Move handling (same logic)
  if (mode === 'Swish and Match') {
    const bonusCount = matchedValues.filter(v => v === 9).length;
    if (bonusCount > 0) {
      movesLeft += bonusCount;
      bonusSound.currentTime = 0;
      bonusSound.play();
    } else if (isPlayerMove) {
      movesLeft--;
    }
    updateHUD();
    if (movesLeft <= 0) {
      noMovesLeftSound.currentTime = 0;
      noMovesLeftSound.play();
      setTimeout(() => gameOver('No Move Left!'), 500);
    }
  } else {
    updateHUD();
  }

 
  collapseAndRefill(); // 


  await new Promise(r => setTimeout(r, 140));

  // recursive resolution
  await resolveMatchesAndCascade(false, false);


  if (!hasPossibleMoves()) {
    showShuffleOverlay(1200);
    setTimeout(() => animateShuffleAndResolve(), 1300);
  }


  const allTiles = Array.from(innerBoard.querySelectorAll('.tile'));
  allTiles.forEach(t => { if (t.dataset.busy) delete t.dataset.busy; t.classList.remove('matching'); });

  isResolving = false;
}
//Cascade Helper

function recordScore() {
  if (playerName && score > 0) {
    submitScore(playerName, score, mode);
  }
}

function gameOver(reason) {
  clearInterval(timerInterval);
  clearInterval(dizzyInterval);
  
  alert(`Game Over! ${reason}\n Your total score: ${score}`);
  recordScore();
  
  showMenu();
  
}


function collapseAndRefill(){
  for(let c=0;c<COLS;c++){
    const stack=[];
    for(let r=ROWS-1;r>=0;r--) if(board[r][c]!=null) stack.push(board[r][c]);
    while(stack.length<ROWS) stack.push(randomCandyValue());
    for(let r=ROWS-1,i=0;r>=0;r--,i++) board[r][c]=stack[i];
  }
  renderWholeBoard();
}

function startDizzy() {
  clearInterval(dizzyInterval);
  dizzyInterval = setInterval(async () => {
    let anyChange = false;

    // collect changes so we can await them if needed
    const changePromises = [];

    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        if (Math.random() < 0.08) {
          const t = tileDomAt(r, c);
          if (!t) continue;

          // skip if tile is busy (matching, shaking, etc.)
          if (t.dataset.busy === 'true' || t.classList.contains('shake') || t.classList.contains('matching')) {
            continue;
          }

          anyChange = true;
          t.dataset.busy = 'true';
          t.classList.add('dizzyChange');

          // capture r, c for closure
          (function(rr, cc, tileEl) {
            const p = (async () => {
              await awaitAnimationEnd(tileEl, 'dizzyPop').catch(()=>{});
              // after pop, set new board value and update image, fade-in
              const newVal = randomCandyValue();
              board[rr][cc] = newVal;
              updateTileAt(rr, cc);

              tileEl.classList.remove('dizzyChange');
              tileEl.classList.add('fading-in');

              await awaitAnimationEnd(tileEl, 'fadeInGlow').catch(()=>{}); // optional if you have named keyframe — otherwise wait small timeout
              setTimeout(() => { tileEl.classList.remove('fading-in'); }, 600);

              delete tileEl.dataset.busy;
            })();
            changePromises.push(p);
          })(r, c, t);
        }
      }
    }

    // when any changed, after all done resolve matches
    if (anyChange) {
      try {
        await Promise.all(changePromises);
      } catch(e) { /* ignore */ }
      // give a tiny delay, then resolve matches normally
      await new Promise(r => setTimeout(r, 80));
      // call resolveMatchesAndCascade in case dizzy produced matches
      await resolveMatchesAndCascade(false, false);
    }
  }, 2000);
}

function showMenu(){
  stopMusic();
  mainMenu.style.display='flex';
  gameContainer.style.display='none';
  musicPlayerBox.style.display='none';
  
  clearInterval(timerInterval);
  clearInterval(dizzyInterval);
  
  const timerDisplay = document.getElementById('timerDisplay');
  if (timerDisplay) {
    timerDisplay.classList.remove('time-warning');
    timerDisplay.textContent = ''; // optional: clear timer text
  }
  
  menuMusic.currentTime = 0;
  menuMusic.play().catch(e => console.log("Autoplay blocked:", e));
  gameTitle.classList.add("animate");

    // Optional: remove class after animation ends so it won’t repeat
    setTimeout(() => {
      gameTitle.classList.remove("animate");
    }, 1500);
}


function startGame(selectedMode){
  
  menuMusic.pause();
  menuMusic.currentTime = 0;
  
  startMusic();
  
  mode = selectedMode;
  score = 0; movesLeft = 20; firstSelection=null;
  
  mainMenu.style.display='none';
  gameContainer.style.display='flex';
  musicPlayerBox.style.display='flex';
  
  createBoardInitial();
  updateHUD();
  
  if(mode==='Hurry Hurry') startTimer();
  else if(mode==='Dizzy Dizzy') startDizzy();
}

document.getElementById('classicBtn').onclick = ()=>startGame('Classic');
document.getElementById('hurryBtn').onclick = ()=>startGame('Hurry Hurry');
document.getElementById('dizzyBtn').onclick = ()=>startGame('Dizzy Dizzy');
document.getElementById('swishBtn').onclick = ()=>startGame('Swish and Match');
document.getElementById('backButton').onclick = () => {submitScore(playerName, score, mode); showMenu(); };


const menuMusic = new Audio('sounds/Moshi Moshi JP ver-instrumental.mp3'); 
menuMusic.loop = true; // loop while on menu
menuMusic.volume = 0.5; // adjust volume


const songs = [
  { title: "Any Angle(원곡 : 乃紫)", file: "https://www.youtube.com/watch?v=DSB5g073z9Y ", type: "youtube" },
  { title: "Butterfly's Dream", file: "https://www.youtube.com/watch?v=Pd--ARdOC_c", type: "youtube" },
  { title: "Curious", file: "https://www.youtube.com/watch?v=V3Xpaadt-RA", type: "youtube" },
  { title: "Dating Myself", file: "https://www.youtube.com/watch?v=zAb7_f45Zh8", type: "youtube" },
  { title: "DDANG!", file: "https://www.youtube.com/watch?v=eNEfyLw3WfQ&pp=ygUKdW5pcyBkZGFuZw%3D%3D", type: "youtube" },
  { title: "Dopamine", file: "https://www.youtube.com/watch?v=7xHZpIxtSZ4", type: "youtube" },
  { title: "Dream of Girls", file: "https://www.youtube.com/watch?v=4W0Qx8gZWKk", type: "youtube" },
  { title: "From The Seed Called Hey Whats Up", file: "https://www.youtube.com/watch?v=vEmwBHJugkY", type: "youtube" },
  { title: "Good Feeling", file: "sounds/Good Feeling.mp4", type: "video" },
  { title: "Love, Day After Tomorrow", file: "https://www.youtube.com/watch?v=uEYKrHztkKE", type: "youtube" },
  { title: "Moshi Moshi EN ver.", file: "https://www.youtube.com/watch?v=RvZEOq5MGzY", type: "youtube" },
  { title: "Moshi Moshi JP ver.", file: "https://www.youtube.com/watch?v=DrU5bxPcH0s", type: "youtube" },
  { title: "Poppin", file: "https://www.youtube.com/watch?v=iezL1ao7s8k", type: "youtube" },
  { title: "See you in my dream (꿈에서 또 만나)", file: "https://www.youtube.com/watch?v=MOudTwsEXzU", type: "youtube" },
  { title: "Shaking My Head", file: "https://www.youtube.com/watch?v=hGNdSFlWUvA", type: "youtube" },
  { title: "Spring Rain", file: "https://www.youtube.com/watch?v=LRMRr22T7UQ&pp=ygUQdW5pcyBzcHJpbmcgcmFpbg%3D%3D", type: "youtube" },
  { title: "Superwoman", file: "sounds/Superwoman.mp4", type: "video" },
  { title: "Swicy", file: "sounds/swicy.mp4", type: "video" },
  { title: "Watchu Need", file: "https://www.youtube.com/watch?v=aE2sk_LbR78", type: "youtube" }  
];


let currentSongIndex = 0;
let isPlaying = false;
const video = document.getElementById("videoPlayer");
const audio = document.getElementById("audioPlayer");
const playBtn = document.getElementById("playBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const progressBar = document.getElementById("progressBar");
const songTitle = document.getElementById("songTitle");
const songList = document.getElementById("songList");

const youtubeContainer = document.getElementById("youtubePlayerContainer");
const youtubeIframe = document.getElementById("youtubePlayer");

let youtubePlayer;

function onYouTubeIframeAPIReady() {
  youtubePlayer = new YT.Player("youtubePlayer", {
    height: "100%",
    width: "100%",
    videoId: "",  // will be set dynamically
    playerVars: {
      rel: 0,
      modestbranding: 1,
      controls: 1   // set to 0 if you want only your custom buttons
    },
    events: {
    onReady: () => console.log("YouTube Player Ready"),
	onStateChange: (event) => {
	  if (event.data === YT.PlayerState.ENDED) {
		stopYouTubeProgress();
		nextSong();
	  } else if (event.data === YT.PlayerState.PLAYING) {
		isPlaying = true;
		playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
		startYouTubeProgress();
	  } else if (event.data === YT.PlayerState.PAUSED) {
		isPlaying = false;
		playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
		stopYouTubeProgress();
	  }
	}

}
  });
}
function loadSong(index, autoplay = false) {
  currentSongIndex = index;
  const song = songs[index];
  songTitle.textContent = song.title;

  // Hide everything first
  audio.style.display = "none";
  video.style.display = "none";
  youtubePlayerContainer.style.display = "none"; // 🔹 hide by default

if (song.type === "local") {
  // stop YT
  if (youtubePlayer && youtubePlayer.stopVideo) {
    youtubePlayer.stopVideo();
  }

  youtubePlayerContainer.style.display = "none";
  video.style.display = "none";
  audio.style.display = "block";
  audio.src = song.file;
  if (autoplay) audio.play();

} else if (song.type === "video") {
  // stop YT
  if (youtubePlayer && youtubePlayer.stopVideo) {
    youtubePlayer.stopVideo();
  }

  youtubePlayerContainer.style.display = "none";
  audio.style.display = "none";
  video.style.display = "block";
  video.src = song.file;
  if (autoplay) video.play();

} else if (song.type === "youtube") {
  // pause audio/video
  audio.pause();
  video.pause();

  youtubePlayerContainer.style.display = "block";

  const videoIdMatch = song.file.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  const videoId = videoIdMatch ? videoIdMatch[1] : null;

  if (autoplay) {
    youtubePlayer.loadVideoById(videoId);
  } else {
    youtubePlayer.cueVideoById(videoId);
  }
}

  isPlaying = autoplay;
  playBtn.innerHTML = autoplay
    ? '<i class="bi bi-pause-fill"></i>'
    : '<i class="bi bi-play-fill"></i>';
}



function playSong() {
  const song = songs[currentSongIndex];
  if (song.type === "local") {
    audio.play();
  } else if (song.type === "video") {
    video.play();
  } else if (song.type === "youtube") {
    youtubePlayer.playVideo();
  }
  isPlaying = true;
  playBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
}

function pauseSong() {
  const song = songs[currentSongIndex];
  if (song.type === "local") {
    audio.pause();
  } else if (song.type === "video") {
    video.pause();
  } else if (song.type === "youtube") {
    youtubePlayer.pauseVideo();
  }
  isPlaying = false;
  playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
}

function nextSong(){
  let nextIndex = (currentSongIndex + 1) % songs.length;
  loadSong(nextIndex, true);
}

function prevSong(){
  let prevIndex = (currentSongIndex - 1 + songs.length) % songs.length;
  loadSong(prevIndex, true);
}

// Controls
playBtn.onclick = () => isPlaying ? pauseSong() : playSong();
nextBtn.onclick = nextSong;
prevBtn.onclick = prevSong;

// Volume
const volumeSlider = document.getElementById("volumeSlider");

// initialize volumes
audio.volume = volumeSlider.value / 100;
video.volume = volumeSlider.value / 100;

volumeSlider.addEventListener("input", e => {
  const vol = e.target.value / 100;

  // MP3
  audio.volume = vol;

  // MP4/WebM
  video.volume = vol;

  // YouTube
  if (youtubePlayer) {
    youtubePlayer.setVolume(vol * 100); // YT expects 0–100
  }
});

audio.addEventListener("timeupdate", () => {
  if(audio.duration) {
    const progress = (audio.currentTime / audio.duration) * 100;
    progressBar.style.width = `${progress}%`;
  }
});

audio.addEventListener("ended", nextSong);

// build dropup list
songs.forEach((s, idx) => {
  const li = document.createElement("li");
  const btn = document.createElement("button");
  btn.className = "dropdown-item";
  btn.textContent = s.title;
  btn.onclick = () => loadSong(idx, true);
  li.appendChild(btn);
  songList.appendChild(li);
});

// random autoplay when "game starts"
function startMusic() {
  const randomIndex = Math.floor(Math.random() * songs.length);
  loadSong(randomIndex, true);
}

// stop music when "back" clicked
function stopMusic() {
  // stop all
  audio.pause();
  video.pause();
  if (youtubePlayer && youtubePlayer.stopVideo) {
    youtubePlayer.stopVideo();
  }

  audio.currentTime = 0;
  video.currentTime = 0;

  isPlaying = false;
  progressBar.style.width = "0%";
  playBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
}

let ytProgressInterval = null;

function startYouTubeProgress() {
  clearInterval(ytProgressInterval);
  ytProgressInterval = setInterval(() => {
    if (youtubePlayer && youtubePlayer.getDuration) {
      const duration = youtubePlayer.getDuration();
      const currentTime = youtubePlayer.getCurrentTime();
      if (duration > 0) {
        const progress = (currentTime / duration) * 100;
        progressBar.style.width = `${progress}%`;
      }
    }
  }, 500); // update every 0.5s
}

const progressContainer = document.querySelector(".progress");

progressContainer.addEventListener("click", (e) => {
  const rect = progressContainer.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const percentage = clickX / rect.width;

  const song = songs[currentSongIndex];

  if (song.type === "local" && audio.duration) {
    // Seek MP3
    audio.currentTime = audio.duration * percentage;
  } else if (song.type === "youtube" && youtubePlayer && youtubePlayer.getDuration) {
    // Seek YouTube
    const newTime = youtubePlayer.getDuration() * percentage;
    youtubePlayer.seekTo(newTime, true);
  }
});

let isScrubbing = false;

progressContainer.addEventListener("mousedown", (e) => {
  isScrubbing = true;
  seek(e); // jump immediately when click
});

document.addEventListener("mousemove", (e) => {
  if (isScrubbing) {
    seek(e);
  }
});

document.addEventListener("mouseup", () => {
  if (isScrubbing) {
    isScrubbing = false;
  }
});

function seek(e) {
  const rect = progressContainer.getBoundingClientRect();
  const clickX = Math.min(Math.max(e.clientX - rect.left, 0), rect.width);
  const percentage = clickX / rect.width;

  const song = songs[currentSongIndex];

  if (song.type === "local" && audio.duration) {
    audio.currentTime = audio.duration * percentage;
  } else if (song.type === "youtube" && youtubePlayer && youtubePlayer.getDuration) {
    const newTime = youtubePlayer.getDuration() * percentage;
    youtubePlayer.seekTo(newTime, true);
  }

  // Update UI immediately while dragging
  progressBar.style.width = `${percentage * 100}%`;
}

function stopYouTubeProgress() {
  clearInterval(ytProgressInterval);
  ytProgressInterval = null;
}

async function submitScore(name, score, mode) {
  const { data, error } = await supabase
    .from('leaderboard')
    .insert([{ name, score, mode, date: new Date() }]);

  if (error) {
    console.error("❌ Error submitting score:", error);
  } else {
    console.log("✅ Score submitted:", data);
  }
}

async function loadLeaderboard(mode) {
  const { data, error } = await supabase
    .from('leaderboard')
    .select('name, score')
    .eq('mode', mode)              // filter by current mode
    .order('score', { ascending: false })
    .limit(10);

  if (error) {
    console.error("❌ Error loading leaderboard:", error);
    return [];
  }
  return data;
}

async function renderLeaderboard(mode, containerId) {
  const scores = await loadLeaderboard(mode);
  const container = document.getElementById(containerId);

  container.innerHTML = scores.length > 0
    ? `
      <table class="table table-sm table-striped">
        <thead><tr><th>#</th><th>Name</th><th>Score</th></tr></thead>
        <tbody>
          ${scores.map((s, i) =>
            `<tr><td>${i + 1}</td><td>${s.name}</td><td>${s.score}</td></tr>`
          ).join("")}
        </tbody>
      </table>
    `
    : "<p><em>No scores yet</em></p>";
}

// When leaderboard modal opens, load all tabs
document.getElementById('leaderboardModal')
  .addEventListener('show.bs.modal', () => {
    renderLeaderboard("Classic", "leaderboard-classic");
    renderLeaderboard("Hurry Hurry", "leaderboard-hurry");
    renderLeaderboard("Dizzy Dizzy", "leaderboard-dizzy");
    renderLeaderboard("Swish and Match", "leaderboard-swish");
  });

</script>

</body>
</html>
